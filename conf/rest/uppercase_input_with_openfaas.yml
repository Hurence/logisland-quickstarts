#########################################################################################################
# Logisland configuration script template
#########################################################################################################

version: 1.2.0
documentation: LogIsland main config file. Put here every engine or component config

#########################################################################################################
# engine
engine:
  component: com.hurence.logisland.engine.spark.KafkaStreamProcessingEngine
  type: engine
  documentation: A logisland stream that convert all string to uppercase using an openfaas method
  configuration:
    spark.app.name: OpenFaasDemo
    spark.master: local[4]
    spark.driver.memory: 1g
    spark.driver.cores: 1
    spark.executor.memory: 2g
    spark.executor.instances: 4
    spark.executor.cores: 2
    spark.yarn.queue: default
    spark.yarn.maxAppAttempts: 4
    spark.yarn.am.attemptFailuresValidityInterval: 1h
    spark.yarn.max.executor.failures: 20
    spark.yarn.executor.failuresValidityInterval: 1h
    spark.task.maxFailures: 8
    spark.serializer: org.apache.spark.serializer.KryoSerializer
    spark.streaming.batchDuration: 10000
    spark.streaming.backpressure.enabled: false
    spark.streaming.unpersist: false
    spark.streaming.blockInterval: 500
    spark.streaming.kafka.maxRatePerPartition: 3000
    spark.streaming.timeout: -1
    spark.streaming.kafka.maxRetries: 3
    spark.streaming.ui.retainedBatches: 200
    spark.streaming.receiver.writeAheadLog.enable: false
    spark.ui.port: 4053

  controllerServiceConfigurations:

    - controllerService: faas_service_rest
      component: com.hurence.logisland.rest.service.lookup.RestLookupService
      configuration:
        rest.lookup.url: http://192.168.99.100:31112/function/${function_name}
        record.serializer: com.hurence.logisland.serializer.ExtendedJsonSerializer
        #record.schema: ff
        rest.lookup.basic.auth.username: admin
        rest.lookup.basic.auth.password: 4f1c1b3f032b635cf1a4b1cb3d9a514412d0b7ab
        rest.lookup.digest.auth: false
        #eventuellement SSL config dans un second temps

  streamConfigurations:

    - stream: parsing_stream
      component: com.hurence.logisland.stream.spark.KafkaRecordStreamParallelProcessing
      configuration:
        kafka.input.topics: logisland_raw
        kafka.output.topics: logisland_events
        kafka.error.topics: logisland_errors
        kafka.input.topics.serializer: none
        kafka.output.topics.serializer: com.hurence.logisland.serializer.JsonSerializer
        kafka.error.topics.serializer: com.hurence.logisland.serializer.JsonSerializer
        kafka.metadata.broker.list: kafka:9092
        kafka.zookeeper.quorum: zookeeper:2181
        kafka.topic.autoCreate: true
        kafka.topic.default.partitions: 4
        kafka.topic.default.replicationFactor: 1
      processorConfigurations:

        # a parser that produce events from an apache log REGEX
        - processor: apache_parser
          component: com.hurence.logisland.processor.SplitText
          configuration:
            record.type: apache_log
            value.regex: (\S+)\s+(\S+)\s+(\S+)\s+\[([\w:\/]+\s[+\-]\d{4})\]\s+"(\S+)\s+(\S+)\s*(\S*)"\s+(\S+)\s+(\S+)
            value.fields: src_ip,identd,user,record_time,http_method,http_query,http_version,http_status,bytes_out
        # add field for openfaas method to use
        - processor: add_function_name
          component: com.hurence.logisland.processor.AddFields
          configuration:
            function_name: uppercase
        # add field if defect found
        - processor: defect_tagger
          component: com.hurence.logisland.rest.processor.lookup.CallRequest
          configuration:
            http.client.service: faas_service_rest
            strategy: overwrite_existing
            field.http.response: copy_to_uppercase
            request.method: "POST"
            request.mime.type: "application/json"
            input.as.body: true
        - processor: flatten
          component: com.hurence.logisland.processor.FlatMap
          documentation: "extract response from root record and remove root record"
          configuration:
            keep.root.record: false
            copy.root.record.fields: false
            leaf.record.type: http_response